<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>é£Ÿå“æ¢ç¢¼ GS1 åœ‹åˆ¥æŸ¥è©¢å·¥å…·</title>
  
  <!-- è¼‰å…¥ Quagga2 SDK (å°ˆè²¬ 1D / EAN-13 æ¢ç¢¼) -->
  <script src="https://cdn.jsdelivr.net/npm/@ericblade/quagga2@1.12.1/dist/quagga.min.js"></script>
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f0f2f5;
      margin: 0; padding: 15px; box-sizing: border-box;
    }
    .header {
      display: flex; justify-content: space-between;
      align-items: center; margin-bottom: 15px;
    }
    .title { margin: 0; color: #333; font-size: 20px; font-weight: bold; }
    .lang-select {
      padding: 5px 8px; border-radius: 5px;
      border: 1px solid #ccc; font-size: 14px; background: #fff;
    }

    /* æé†’å€å¡Š */
    .alert-warning {
      background-color: #fff3cd;
      color: #856404;
      border: 1px solid #ffeeba;
      padding: 12px 15px;
      border-radius: 8px;
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 15px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }
    .alert-warning strong { color: #d32f2f; }

    .card {
      background: #fff; padding: 20px; border-radius: 10px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1); margin-bottom: 15px;
    }
    
    label { font-weight: bold; display: block; margin-bottom: 8px; color: #444; }
    .input-group {
      display: flex; gap: 8px; margin-bottom: 15px;
    }
    input[type="text"] {
      flex: 1; padding: 12px; font-size: 18px; letter-spacing: 1px;
      border: 1px solid #ccc; border-radius: 6px;
      background-color: #fafafa; outline: none;
    }
    input[type="text"]:focus {
      border-color: #0d6efd; box-shadow: 0 0 5px rgba(13, 110, 253, 0.3);
    }
    button {
      padding: 12px; font-size: 16px; border: none; border-radius: 6px; 
      cursor: pointer; font-weight: bold; transition: opacity 0.2s;
    }
    button:active { opacity: 0.8; }
    
    .btn-query { background-color: #198754; color: white; width: 100%; margin-bottom: 10px; }
    .btn-scan  { background-color: #0d6efd; color: white; width: 100%; font-size: 18px; padding: 16px;}

    /* â”€â”€ éš±ç§æ¬ŠæŒ‰éˆ•èˆ‡å½ˆçª— UI â”€â”€ */
    .link-button {
      background: none; border: none; padding: 0; color: #0d6efd;
      text-decoration: underline; cursor: pointer; font-size: 14px;
    }
    #privacyModal.modal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); z-index: 3000; justify-content: center; align-items: center; padding: 15px;
    }
    #privacyModal .modal-content {
      background: #fff; border-radius: 12px; width: 100%; max-width: 520px;
      padding: 20px; text-align: left; line-height: 1.6; position: relative;
    }
    .privacy-title { margin: 0 0 10px 0; font-size: 18px; font-weight: bold; }
    .privacy-list { margin: 10px 0 0 20px; padding: 0; font-size: 14px; color: #333; }
    .privacy-list li { margin-bottom: 8px; }

    /* â”€â”€ æƒæå™¨è¦†è“‹å±¤ â”€â”€ */
    #scanner-container {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.95); z-index: 1000;
      flex-direction: column; align-items: center;
      padding: 8px 10px;
      padding-top: calc(10px + env(safe-area-inset-top, 0px));
      padding-bottom: calc(10px + env(safe-area-inset-bottom, 0px));
      box-sizing: border-box;
    }

    /* é ‚éƒ¨æ“ä½œåˆ— */
    .top-controls-wrap {
      flex-shrink: 0; width: 100%; max-width: 520px;
      display: flex; align-items: center; gap: 8px; margin-bottom: 12px;
    }
    .camera-selector-wrap { flex: 1; display: flex; align-items: center; gap: 8px; }
    .camera-selector-wrap label { color: #fff; font-size: 14px; white-space: nowrap; margin: 0; font-weight: normal; }
    #cameraSelect {
      flex: 1; padding: 8px 10px; font-size: 14px;
      border-radius: 6px; border: 1px solid rgba(255,255,255,0.35);
      background: rgba(255,255,255,0.12); color: #fff;
    }
    #cameraSelect option { color: #333; background: #fff; }
    
    /* æ‰‹é›»ç­’æŒ‰éˆ•èˆ‡å‹•ç•« */
    #btn-torch {
      display: none; flex-shrink: 0; padding: 8px 14px; font-size: 18px;
      border-radius: 6px; background: rgba(255,255,255,0.15);
      border: 1px solid rgba(255,255,255,0.4); color: #fff; cursor: pointer;
    }
    #btn-torch.active { background: #ffc107; color: #000; border-color: #ffc107; }
    @keyframes shake {
      0% { transform: translateX(0); } 25% { transform: translateX(-4px); }
      50% { transform: translateX(4px); } 75% { transform: translateX(-4px); } 100% { transform: translateX(0); }
    }
    .error-shake { animation: shake 0.3s; background: #dc3545 !important; border-color: #dc3545 !important; }

    /* Quagga2 å¼•æ“å®¹å™¨ */
    #reader-wrap {
      width: 100%; max-width: 520px; flex: 1; min-height: 0;
      position: relative; overflow: hidden; border-radius: 10px; background: #000;
    }
    #quagga-reader { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
    #quagga-reader video, #quagga-reader canvas {
      width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0;
    }

    /* è¼”åŠ© UI æ¡† (1D é•·æ¢å½¢) */
    #scanGuide {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      pointer-events: none; box-sizing: border-box;
      border: 1px solid rgba(255,255,255,0.12); border-radius: 10px;
      filter: drop-shadow(0 0 6px rgba(0,0,0,0.35)); z-index: 10;
      width: min(90%, 460px); height: clamp(110px, 20vh, 160px);
    }
    .corner {
      position: absolute; width: 26px; height: 26px; box-sizing: border-box;
      border: 4px solid rgba(0, 229, 255, 0.9); filter: drop-shadow(0 0 6px rgba(0,229,255,0.18));
    }
    .corner.tl { left: -2px; top: -2px; border-right: 0; border-bottom: 0; border-top-left-radius: 10px; }
    .corner.tr { right: -2px; top: -2px; border-left: 0; border-bottom: 0; border-top-right-radius: 10px; }
    .corner.bl { left: -2px; bottom: -2px; border-right: 0; border-top: 0; border-bottom-left-radius: 10px; }
    .corner.br { right: -2px; bottom: -2px; border-left: 0; border-top: 0; border-bottom-right-radius: 10px; }
    .scan-line {
      position: absolute; left: 10px; right: 10px; top: 50%; height: 2px;
      background: rgba(255, 70, 70, 0.85); box-shadow: 0 0 10px rgba(255, 70, 70, 0.35); transform: translateY(-50%);
    }

    .btn-cancel-scan {
      flex-shrink: 0; margin-top: 15px; margin-bottom: 4px;
      background-color: #dc3545; color: white; width: auto; padding: 10px 30px; font-size: 16px;
    }

    /* â”€â”€ çµæœ Modal â”€â”€ */
    .modal {
      display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.6); z-index: 2000; justify-content: center; align-items: center;
      padding: 15px;
    }
    .modal-content {
      background: white; padding: 25px; border-radius: 12px; width: 100%; max-width: 420px;
      text-align: center; font-size: 16px; line-height: 1.6; position: relative;
    }
    .modal-title { font-size: 22px; font-weight: bold; margin-top: 0; margin-bottom: 15px; color: #198754; }
    .barcode-result { font-size: 24px; font-weight: bold; letter-spacing: 2px; color: #333; margin: 10px 0; background: #f8f9fa; padding: 10px; border-radius: 6px;}
    .country-result { font-size: 28px; font-weight: bold; color: #0d6efd; margin: 15px 0; }
    .prefix-info { font-size: 15px; color: #666; margin-bottom: 15px;}
    
    .modal-warning {
      background-color: #fff3cd; color: #856404; font-size: 13px; text-align: left;
      padding: 10px; border-radius: 6px; margin: 15px 0; border-left: 4px solid #ffc107;
    }
  </style>
</head>
<body>

  <div class="header">
    <h1 class="title" id="ui-title">GS1 é£Ÿå“åœ‹åˆ¥æŸ¥è©¢</h1>
    <select class="lang-select" id="langSelector" onchange="changeLanguage()">
      <option value="zh-TW" selected>ç¹é«”ä¸­æ–‡</option>
      <option value="en">English</option>
    </select>
  </div>

  <!-- é¦–é å›ºå®šæé†’ -->
  <div class="alert-warning" id="ui-warning-main">
    <strong>âš ï¸ æé†’ï¼š</strong>é£Ÿå“ç·¨ç¢¼é–‹é ­ä¸‰ç¢¼ï¼Œä»£è¡¨ç™¼è¡Œè©²æ¢ç¢¼çš„ GS1 æœƒå“¡çµ„ç¹”æ‰€åœ¨åœ‹å®¶/åœ°å€ï¼Œ<span style="text-decoration: underline;">ä¸ç­‰æ–¼</span>ç”¢å“å¯¦éš›è£½é€ åœ‹ã€‚
  </div>

  <!-- éš±ç§æ¬ŠæŒ‰éˆ• -->
  <div style="margin: 5px 0 15px 0; text-align: left;">
    <button type="button" class="link-button" id="ui-privacy-link" onclick="openPrivacyModal()">
      éš±ç§æ¬Šæ‘˜è¦
    </button>
  </div>

  <div class="card">
    <label id="ui-input-label">æ‰‹å‹•è¼¸å…¥å•†å“æ¢ç¢¼ (EAN-13)</label>
    <div class="input-group">
      <input type="text" id="barcodeInput" placeholder="ä¾‹å¦‚: 4710000000000" inputmode="numeric" pattern="[0-9]*">
    </div>
    <button class="btn-query" id="ui-btn-query" onclick="manualQuery()">ğŸ” æŸ¥è©¢åœ‹åˆ¥</button>
  </div>

  <button class="btn-scan" id="ui-btn-scan" onclick="startScan()">ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒææ¢ç¢¼</button>

  <!-- æƒæç•«é¢ UI -->
  <div id="scanner-container">
    <div class="alert-warning" style="width: 100%; max-width: 520px; font-size: 13px; padding: 8px; margin-bottom: 10px; background: rgba(255,243,205,0.9); border:none;" id="ui-warning-scan">
      è«‹å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®ç´…ç·šå€åŸŸ
    </div>
    
    <div class="top-controls-wrap">
      <div class="camera-selector-wrap">
        <select id="cameraSelect" onchange="switchCamera(this.value)" disabled>
          <option id="ui-camera-loading-opt">è¼‰å…¥é¡é ­æ¸…å–®...</option>
        </select>
      </div>
      <button id="btn-torch" onclick="toggleTorch()" title="é–‹é—œæ‰‹é›»ç­’">ğŸ”¦</button>
    </div>

    <div id="reader-wrap">
      <div id="quagga-reader"></div>
      <div id="scanGuide">
        <span class="corner tl"></span><span class="corner tr"></span>
        <span class="corner bl"></span><span class="corner br"></span>
        <div class="scan-line"></div>
      </div>
    </div>

    <button class="btn-cancel-scan" id="ui-btn-cancel" onclick="stopScan()">å–æ¶ˆ</button>
  </div>

  <!-- éš±ç§æ¬Šå½ˆçª— -->
  <div id="privacyModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="privacyTitle">
    <div class="modal-content">
      <h3 class="privacy-title" id="privacyTitle">éš±ç§æ¬Šæ‘˜è¦ (Privacy Summary)</h3>
      <div id="privacyContent"></div>
      <button type="button" class="btn-cancel-scan" style="width:100%; margin-top: 15px; padding: 10px;" id="ui-privacy-close" onclick="closePrivacyModal()">
        é—œé–‰
      </button>
    </div>
  </div>

  <!-- çµæœå½ˆå‡ºè¦–çª— -->
  <div id="resultModal" class="modal">
    <div class="modal-content">
      <h2 class="modal-title" id="ui-modal-title">æŸ¥è©¢çµæœ</h2>
      <div class="prefix-info" id="ui-modal-barcode-lbl">æƒææ¢ç¢¼ï¼š</div>
      <div class="barcode-result" id="modalBarcode">4711234567890</div>
      
      <div class="prefix-info"><span id="ui-modal-prefix-lbl">GS1 å‰ç½®ç¢¼ (å‰ 3 ç¢¼)ï¼š</span><strong style="color:#000;" id="modalPrefix">471</strong></div>
      
      <div class="country-result" id="modalCountry">å°ç£ (Taiwan)</div>

      <div class="modal-warning" id="ui-warning-modal">
        <strong>âš ï¸ æé†’ï¼š</strong>æ­¤åœ‹å®¶/åœ°å€ç‚ºè©²æ¢ç¢¼çš„ç™¼è¡Œçµ„ç¹”æ‰€åœ¨åœ°ï¼Œä¸ä»£è¡¨è©²ç”¢å“çš„å¯¦éš›åŸç”¢åœ°æˆ–è£½é€ åœ‹ã€‚
      </div>

      <button class="btn-cancel-scan" style="width:100%; margin-top:10px;" id="ui-btn-close" onclick="closeModal()">é—œé–‰</button>
    </div>
  </div>

  <script>
    // â”€â”€ éš±ç§æ¬Šå½ˆçª—æ§åˆ¶ â”€â”€
    function openPrivacyModal() { document.getElementById('privacyModal').style.display = 'flex'; }
    function closePrivacyModal() { document.getElementById('privacyModal').style.display = 'none'; }
    
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('privacyModal');
      if (modal && modal.style.display === 'flex' && e.target === modal) closePrivacyModal();
    });
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closePrivacyModal(); });

    // â”€â”€ å…¨åŸŸè®Šæ•¸ â”€â”€
    let isQuaggaScanning = false;
    let quaggaLastCode   = "";
    let quaggaCodeCount  = 0;
    const REQUIRED_MATCHES = 2; // é˜²æŠ–ï¼šé€£çºŒè®€å–å…©æ¬¡ç›¸åŒæ‰ç®—æˆåŠŸ
    let currentCameraId  = null;
    let isTorchOn        = false;
    let currentLang      = 'zh-TW';

    // â”€â”€ å¤šåœ‹èªç³» â”€â”€
    const translations = {
      'zh-TW': {
        title: 'GS1 é£Ÿå“åœ‹åˆ¥æŸ¥è©¢',
        privacyLink   : 'éš±ç§æ¬Šæ‘˜è¦',
        privacyTitle  : 'éš±ç§æ¬Šè²æ˜èˆ‡å‘ŠçŸ¥äº‹é … (Privacy Summary)',
        privacyHtml   : `
          <ul class="privacy-list">
            <li><strong>è™•ç†æ–¹å¼èˆ‡ç¯„åœï¼š</strong>æœ¬å·¥å…·ç‚ºç´”å‰ç«¯ç¶²é æ‡‰ç”¨ç¨‹å¼ï¼ŒEAN-13 æ¢ç¢¼æƒæèˆ‡ GS1 åœ‹åˆ¥å‰ç½®ç¢¼åˆ¤è®€çš†åœ¨æ‚¨çš„è£ç½®æœ¬æ©Ÿç€è¦½å™¨å…§å®Œæˆã€‚æœ¬ç¨‹å¼ä¸æœƒå°‡æƒæçš„æ¢ç¢¼ã€ç›¸æ©Ÿå½±åƒæˆ–æŸ¥è©¢çµæœä¸Šå‚³è‡³ä»»ä½•å¾Œç«¯ä¼ºæœå™¨ã€‚</li>
            <li><strong>æ¬Šé™èˆ‡æ§åˆ¶ï¼š</strong>ç›¸æ©Ÿæ¬Šé™åƒ…åœ¨æ‚¨å•Ÿå‹•æƒææ™‚ä½¿ç”¨ï¼Œæ‚¨å¯æ–¼ç€è¦½å™¨è¨­å®šä¸­éš¨æ™‚æ’¤éŠ·æ¬Šé™ã€‚æˆ‘å€‘ä¸éœ€è¨»å†Šå¸³è™Ÿã€ä¸å»ºç«‹ä½¿ç”¨è€…æ•¸ä½è¶³è·¡æˆ–é€²è¡Œå»ºæª” (Profiling)ã€‚</li>
            <li><strong>ç¬¬ä¸‰æ–¹èˆ‡é€£ç·šç´€éŒ„ï¼š</strong>æœ¬é é¢é€éç¬¬ä¸‰æ–¹ CDN è¼‰å…¥é–‹æºæ¢ç¢¼å¥—ä»¶ï¼Œè©² CDN ä¾›æ‡‰å•†æˆ–ç¶²é ä»£ç®¡å¹³å° (å¦‚ GitHub Pages) å¯èƒ½ä¾å…¶ç³»çµ±é è¨­ä¿ç•™ä¸€èˆ¬æŠ€è¡“æ€§å­˜å–ç´€éŒ„ï¼ˆå¦‚ IP ä½å€ã€User-Agent ç­‰ï¼‰ã€‚</li>
            <li><strong>è³‡æ–™ä¾†æºï¼š</strong>æœ¬ç¨‹å¼å…§å»ºä¹‹ GS1 å‰ç½®ç¢¼å°ç…§è³‡æ–™å±¬å…¬é–‹è³‡è¨Šå½™æ•´ (å¦‚ Wikipedia ç­‰)ï¼Œåƒ…ä¾›åƒè€ƒã€‚</li>
            <li><strong>ç•¶äº‹äººæ¬Šåˆ©èˆ‡è¯çµ¡æ–¹å¼ï¼š</strong>ç‚ºç¬¦åˆå°ç£å€‹è³‡æ³• (PDPA) åŠæ­ç›Ÿ GDPR ç¬¬13æ¢ä¹‹ç²¾ç¥ï¼Œè‹¥æ‚¨å°å€‹äººè³‡æ–™è™•ç†æœ‰ä»»ä½•ç–‘å•æˆ–æ¬²è¡Œä½¿ç›¸é—œæ¬Šåˆ©ï¼Œè«‹è¯ç¹«ï¼š<a href="mailto:sspig0127+github@gmail.com">sspig0127+github@gmail.com</a></li>
          </ul>
        `,
        warningMain: '<strong>âš ï¸ æé†’ï¼š</strong>é£Ÿå“ç·¨ç¢¼é–‹é ­ä¸‰ç¢¼ï¼Œä»£è¡¨ç™¼è¡Œè©²æ¢ç¢¼çš„ GS1 æœƒå“¡çµ„ç¹”æ‰€åœ¨åœ‹å®¶/åœ°å€ï¼Œ<span style="text-decoration: underline;">ä¸ç­‰æ–¼</span>ç”¢å“å¯¦éš›è£½é€ åœ‹ã€‚',
        warningScan: 'è«‹å°‡æ¢ç¢¼å°æº–ç•«é¢ä¸­å¤®ç´…ç·šå€åŸŸ',
        warningModal: '<strong>âš ï¸ æé†’ï¼š</strong>æ­¤åœ‹å®¶/åœ°å€ç‚ºè©²æ¢ç¢¼çš„ç™¼è¡Œçµ„ç¹”æ‰€åœ¨åœ°ï¼Œä¸ä»£è¡¨è©²ç”¢å“çš„å¯¦éš›åŸç”¢åœ°æˆ–è£½é€ åœ‹ã€‚',
        inputLabel: 'æ‰‹å‹•è¼¸å…¥å•†å“æ¢ç¢¼ (EAN-13)',
        placeholder: 'ä¾‹å¦‚: 4710000000000',
        btnQuery: 'ğŸ” æŸ¥è©¢åœ‹åˆ¥',
        btnScan: 'ğŸ“· å•Ÿå‹•ç›¸æ©Ÿæƒææ¢ç¢¼',
        camLoading: 'è¼‰å…¥é¡é ­...',
        camDefault: 'é è¨­é¡é ­',
        btnCancel: 'å–æ¶ˆ',
        modalTitle: 'æŸ¥è©¢çµæœ',
        modalBarcodeLbl: 'æƒææ¢ç¢¼ï¼š',
        modalPrefixLbl: 'GS1 å‰ç½®ç¢¼ (å‰ 3 ç¢¼)ï¼š',
        btnClose: 'é—œé–‰',
        alertEmpty: 'è«‹è¼¸å…¥æœ‰æ•ˆçš„æ¢ç¢¼æ•¸å­—ï¼',
        alertCamFail: 'ç›¸æ©Ÿå•Ÿå‹•å¤±æ•—ï¼Œè«‹ç¢ºèªæ˜¯å¦å·²æˆæ¬Šã€‚',
        unknownCode: 'æœªçŸ¥å‰ç½®ç¢¼æˆ–æœªåˆ†é…'
      },
      'en': {
        title: 'GS1 Food Barcode Lookup',
        privacyLink   : 'Privacy Summary',
        privacyTitle  : 'Privacy Summary',
        privacyHtml   : `
          <ul class="privacy-list">
            <li><strong>Processing & Scope:</strong> This is a client-side web application. EAN-13 scanning and GS1 prefix lookups run entirely in your local browser. No barcodes, camera frames, or lookup results are uploaded to any server.</li>
            <li><strong>Permissions & Control:</strong> Camera permission is requested only when initiating a scan and can be revoked anytime in your browser settings. No account is required, and we do not profile or track users.</li>
            <li><strong>Third-party & Logs:</strong> This page loads open-source libraries via a third-party CDN. The CDN or hosting provider (e.g., GitHub Pages) may temporarily log standard technical access data (e.g., IP address, User-Agent).</li>
            <li><strong>Data Source:</strong> Internal GS1 prefix mappings are compiled from public references (e.g., Wikipedia) for informational purposes.</li>
            <li><strong>Data Subject Rights & Contact:</strong> In compliance with Taiwan PDPA and GDPR Article 13, for any privacy inquiries or to exercise your rights, please contact: <a href="mailto:sspig0127+github@gmail.com">sspig0127+github@gmail.com</a></li>
          </ul>
        `,
        warningMain: '<strong>âš ï¸ Note:</strong> The first 3 digits represent the GS1 member organization country/region that issued the barcode. It does <span style="text-decoration: underline;">NOT</span> necessarily mean the product was manufactured there.',
        warningScan: 'Align the barcode within the red line',
        warningModal: '<strong>âš ï¸ Note:</strong> This country/region indicates where the barcode was issued, not the product\'s country of origin.',
        inputLabel: 'Manual Barcode Entry (EAN-13)',
        placeholder: 'e.g., 4710000000000',
        btnQuery: 'ğŸ” Lookup Country',
        btnScan: 'ğŸ“· Start Camera Scanner',
        camLoading: 'Loading cameras...',
        camDefault: 'Default Camera',
        btnCancel: 'Cancel',
        modalTitle: 'Lookup Result',
        modalBarcodeLbl: 'Scanned Barcode:',
        modalPrefixLbl: 'GS1 Prefix (first 3 digits): ',
        btnClose: 'Close',
        alertEmpty: 'Please enter a valid barcode number!',
        alertCamFail: 'Camera failed to start. Please check permissions.',
        unknownCode: 'Unknown or Unassigned Prefix'
      }
    };

    function changeLanguage() {
      currentLang = document.getElementById('langSelector').value;
      const t = translations[currentLang];
      
      document.getElementById('ui-title').innerText = t.title;
      document.getElementById('ui-warning-main').innerHTML = t.warningMain;
      document.getElementById('ui-warning-scan').innerText = t.warningScan;
      document.getElementById('ui-warning-modal').innerHTML = t.warningModal;
      document.getElementById('ui-input-label').innerText = t.inputLabel;
      document.getElementById('barcodeInput').placeholder = t.placeholder;
      document.getElementById('ui-btn-query').innerText = t.btnQuery;
      document.getElementById('ui-btn-scan').innerText = t.btnScan;
      document.getElementById('ui-btn-cancel').innerText = t.btnCancel;
      document.getElementById('ui-modal-title').innerText = t.modalTitle;
      document.getElementById('ui-modal-barcode-lbl').innerText = t.modalBarcodeLbl;
      document.getElementById('ui-modal-prefix-lbl').innerText = t.modalPrefixLbl;
      document.getElementById('ui-btn-close').innerText = t.btnClose;
      
      // Privacy UI Update
      document.getElementById('ui-privacy-link').innerText = t.privacyLink;
      document.getElementById('privacyTitle').innerText = t.privacyTitle;
      document.getElementById('privacyContent').innerHTML = t.privacyHtml;
      document.getElementById('ui-privacy-close').innerText = t.btnClose;
    }

    // â”€â”€ GS1 åœ‹åˆ¥å°ç…§è¡¨æ ¸å¿ƒé‚è¼¯ â”€â”€
    function getGS1Country(barcode) {
      if (!barcode || barcode.length < 3) return translations[currentLang].unknownCode;
      
      // ç¢ºä¿æ˜¯è£œæ»¿ 13 ç¢¼çš„ EANï¼Œè‹¥æƒåˆ° UPC-A (12ç¢¼)ï¼ŒQuagga é€šå¸¸æœƒå¹«å¿™è£œ 0
      let fullBarcode = barcode;
      if (fullBarcode.length === 12) fullBarcode = "0" + fullBarcode;

      const prefix = parseInt(fullBarcode.substring(0, 3), 10);

      // åŒ—ç¾
      if (prefix >= 0 && prefix <= 139) return "ç¾åœ‹ (US) / åŠ æ‹¿å¤§ç›¸å®¹";
      if (prefix === 754 || prefix === 755) return "åŠ æ‹¿å¤§ (Canada)";
      
      // äºæ´²
      if (prefix >= 450 && prefix <= 459) return "æ—¥æœ¬ (Japan)";
      if (prefix === 471) return "å°ç£ (Taiwan)";
      if (prefix === 479) return "æ–¯é‡Œè˜­å¡ (Sri Lanka)";
      if (prefix === 480) return "è²å¾‹è³“ (Philippines)";
      if (prefix === 489) return "é¦™æ¸¯ (Hong Kong)";
      if (prefix >= 490 && prefix <= 499) return "æ—¥æœ¬ (Japan)";
      if (prefix >= 680 && prefix <= 681) return "ä¸­åœ‹ (China)";
      if (prefix >= 690 && prefix <= 699) return "ä¸­åœ‹ (China)";
      if (prefix === 865) return "è’™å¤ (Mongolia)";
      if (prefix === 867) return "åŒ—éŸ“ (North Korea)";
      if (prefix >= 880 && prefix <= 881) return "å—éŸ“ (South Korea)";
      if (prefix === 883) return "ç·¬ç”¸ (Myanmar)";
      if (prefix === 884) return "æŸ¬åŸ”å¯¨ (Cambodia)";
      if (prefix === 885) return "æ³°åœ‹ (Thailand)";
      if (prefix === 888) return "æ–°åŠ å¡ (Singapore)";
      if (prefix === 890) return "å°åº¦ (India)";
      if (prefix === 893) return "è¶Šå— (Vietnam)";
      if (prefix === 894) return "å­ŸåŠ æ‹‰ (Bangladesh)";
      if (prefix === 896) return "å·´åŸºæ–¯å¦ (Pakistan)";
      if (prefix === 899) return "å°å°¼ (Indonesia)";
      if (prefix === 955) return "é¦¬ä¾†è¥¿äº (Malaysia)";
      if (prefix === 958) return "æ¾³é–€ (Macau)";

      // æ­æ´²
      if (prefix >= 300 && prefix <= 379) return "æ³•åœ‹èˆ‡æ‘©ç´å“¥ (France & Monaco)";
      if (prefix === 380) return "ä¿åŠ åˆ©äº (Bulgaria)";
      if (prefix === 383) return "æ–¯æ´›ç¶­å°¼äº (Slovenia)";
      if (prefix === 385) return "å…‹ç¾…åŸƒè¥¿äº (Croatia)";
      if (prefix === 387) return "æ³¢å£«å°¼äºèˆ‡èµ«å¡å“¥ç¶­ç´ (Bosnia & Herzegovina)";
      if (prefix === 389) return "è’™ç‰¹å…§å“¥ç¾… (Montenegro)";
      if (prefix >= 400 && prefix <= 440) return "å¾·åœ‹ (Germany)";
      if (prefix >= 460 && prefix <= 469) return "ä¿„ç¾…æ–¯ (Russia)";
      if (prefix === 474) return "æ„›æ²™å°¼äº (Estonia)";
      if (prefix === 475) return "æ‹‰è„«ç¶­äº (Latvia)";
      if (prefix === 477) return "ç«‹é™¶å®› (Lithuania)";
      if (prefix === 481) return "ç™½ä¿„ç¾…æ–¯ (Belarus)";
      if (prefix === 482) return "çƒå…‹è˜­ (Ukraine)";
      if (prefix === 484) return "æ‘©çˆ¾å¤šç“¦ (Moldova)";
      if (prefix >= 500 && prefix <= 509) return "è‹±åœ‹ (UK)";
      if (prefix >= 520 && prefix <= 521) return "å¸Œè‡˜ (Greece)";
      if (prefix === 529) return "è³½æ™®å‹’æ–¯ (Cyprus)";
      if (prefix === 530) return "é˜¿çˆ¾å·´å°¼äº (Albania)";
      if (prefix === 531) return "åŒ—é¦¬å…¶é “ (North Macedonia)";
      if (prefix === 535) return "é¦¬çˆ¾ä»– (Malta)";
      if (prefix === 539) return "æ„›çˆ¾è˜­ (Ireland)";
      if (prefix >= 540 && prefix <= 549) return "æ¯”åˆ©æ™‚èˆ‡ç›§æ£®å ¡ (Belgium & Luxembourg)";
      if (prefix === 560) return "è‘¡è„ç‰™ (Portugal)";
      if (prefix === 569) return "å†°å³¶ (Iceland)";
      if (prefix >= 570 && prefix <= 579) return "ä¸¹éº¥ (Denmark)";
      if (prefix === 590) return "æ³¢è˜­ (Poland)";
      if (prefix === 594) return "ç¾…é¦¬å°¼äº (Romania)";
      if (prefix === 599) return "åŒˆç‰™åˆ© (Hungary)";
      if (prefix >= 640 && prefix <= 649) return "èŠ¬è˜­ (Finland)";
      if (prefix >= 700 && prefix <= 709) return "æŒªå¨ (Norway)";
      if (prefix >= 730 && prefix <= 739) return "ç‘å…¸ (Sweden)";
      if (prefix >= 760 && prefix <= 769) return "ç‘å£«èˆ‡åˆ—æ”¯æ•¦æ–¯ç™» (Switzerland)";
      if (prefix >= 800 && prefix <= 839) return "ç¾©å¤§åˆ© (Italy)";
      if (prefix >= 840 && prefix <= 849) return "è¥¿ç­ç‰™èˆ‡å®‰é“çˆ¾ (Spain)";
      if (prefix === 858) return "æ–¯æ´›ä¼å…‹ (Slovakia)";
      if (prefix === 859) return "æ·å…‹ (Czech Republic)";
      if (prefix === 860) return "å¡çˆ¾ç¶­äº (Serbia)";
      if (prefix >= 870 && prefix <= 879) return "è·è˜­ (Netherlands)";
      if (prefix >= 900 && prefix <= 919) return "å¥§åœ°åˆ© (Austria)";

      // ä¸­æ±èˆ‡ä¸­äº
      if (prefix === 470) return "å‰çˆ¾å‰æ–¯ (Kyrgyzstan)";
      if (prefix === 476) return "äºå¡æ‹œç„¶ (Azerbaijan)";
      if (prefix === 478) return "çƒèŒ²åˆ¥å…‹ (Uzbekistan)";
      if (prefix === 483) return "åœŸåº«æ›¼ (Turkmenistan)";
      if (prefix === 485) return "äºç¾å°¼äº (Armenia)";
      if (prefix === 486) return "å–¬æ²»äº (Georgia)";
      if (prefix === 487) return "å“ˆè–©å…‹ (Kazakhstan)";
      if (prefix === 488) return "å¡”å‰å…‹ (Tajikistan)";
      if (prefix === 528) return "é»å·´å«© (Lebanon)";
      if (prefix === 607) return "é˜¿æ›¼ (Oman)";
      if (prefix === 608) return "å·´æ— (Bahrain)";
      if (prefix === 621) return "æ•˜åˆ©äº (Syria)";
      if (prefix === 625) return "ç´„æ—¦ (Jordan)";
      if (prefix === 626) return "ä¼Šæœ— (Iran)";
      if (prefix === 627) return "ç§‘å¨ç‰¹ (Kuwait)";
      if (prefix === 628) return "æ²™çƒåœ°é˜¿æ‹‰ä¼¯ (Saudi Arabia)";
      if (prefix === 629) return "é˜¿æ‹‰ä¼¯è¯åˆå¤§å…¬åœ‹ (UAE)";
      if (prefix === 630) return "å¡é” (Qatar)";
      if (prefix === 729) return "ä»¥è‰²åˆ— (Israel)";
      if (prefix === 868 || prefix === 869) return "åœŸè€³å…¶ (Turkey)";

      // ä¸­å—ç¾æ´²
      if (prefix === 740) return "ç“œåœ°é¦¬æ‹‰ (Guatemala)";
      if (prefix === 741) return "è–©çˆ¾ç“¦å¤š (El Salvador)";
      if (prefix === 742) return "å®éƒ½æ‹‰æ–¯ (Honduras)";
      if (prefix === 743) return "å°¼åŠ æ‹‰ç“œ (Nicaragua)";
      if (prefix === 744) return "å“¥æ–¯å¤§é»åŠ  (Costa Rica)";
      if (prefix === 745) return "å·´æ‹¿é¦¬ (Panama)";
      if (prefix === 746) return "å¤šæ˜å°¼åŠ å…±å’Œåœ‹ (Dominican Republic)";
      if (prefix === 750) return "å¢¨è¥¿å“¥ (Mexico)";
      if (prefix === 759) return "å§”å…§ç‘æ‹‰ (Venezuela)";
      if (prefix === 770 || prefix === 771) return "å“¥å€«æ¯”äº (Colombia)";
      if (prefix === 773) return "çƒæ‹‰åœ­ (Uruguay)";
      if (prefix === 775) return "ç§˜é­¯ (Peru)";
      if (prefix === 777) return "ç»åˆ©ç¶­äº (Bolivia)";
      if (prefix === 778 || prefix === 779) return "é˜¿æ ¹å»· (Argentina)";
      if (prefix === 780) return "æ™ºåˆ© (Chile)";
      if (prefix === 784) return "å·´æ‹‰åœ­ (Paraguay)";
      if (prefix === 786) return "å„ç“œå¤š (Ecuador)";
      if (prefix === 789 || prefix === 790) return "å·´è¥¿ (Brazil)";
      if (prefix === 850) return "å¤å·´ (Cuba)";

      // éæ´²
      if (prefix >= 600 && prefix <= 601) return "å—é (South Africa)";
      if (prefix === 603) return "è¿¦ç´ (Ghana)";
      if (prefix === 604) return "å¡å…§åŠ çˆ¾ (Senegal)";
      if (prefix === 605) return "çƒå¹²é” (Uganda)";
      if (prefix === 606) return "å®‰å“¥æ‹‰ (Angola)";
      if (prefix === 609) return "æ¨¡é‡Œè¥¿æ–¯ (Mauritius)";
      if (prefix === 611) return "æ‘©æ´›å“¥ (Morocco)";
      if (prefix === 612) return "ç´¢é¦¬åˆ©äº (Somalia)";
      if (prefix === 613) return "é˜¿çˆ¾åŠåˆ©äº (Algeria)";
      if (prefix === 615) return "å¥ˆåŠåˆ©äº (Nigeria)";
      if (prefix === 616) return "è‚¯äº (Kenya)";
      if (prefix === 617) return "å–€éº¥éš† (Cameroon)";
      if (prefix === 618) return "è±¡ç‰™æµ·å²¸ (Ivory Coast)";
      if (prefix === 619) return "çªå°¼è¥¿äº (Tunisia)";
      if (prefix === 620) return "å¦å°šå°¼äº (Tanzania)";
      if (prefix === 622) return "åŸƒåŠ (Egypt)";
      if (prefix === 624) return "åˆ©æ¯”äº (Libya)";
      if (prefix === 631) return "ç´ç±³æ¯”äº (Namibia)";
      if (prefix === 632) return "ç›§å®‰é” (Rwanda)";

      // å¤§æ´‹æ´²
      if (prefix >= 930 && prefix <= 939) return "æ¾³æ´² (Australia)";
      if (prefix >= 940 && prefix <= 949) return "ç´è¥¿è˜­ (New Zealand)";

      // ç‰¹æ®Šç”¨é€”
      if (prefix >= 20 && prefix <= 29) return "å—é™è™Ÿç¢¼ (å€åŸŸå…§/ç”Ÿé®®ç§¤é‡)";
      if (prefix >= 40 && prefix <= 49) return "å—é™è™Ÿç¢¼ (ä¼æ¥­å…§éƒ¨ä½¿ç”¨)";
      if (prefix >= 200 && prefix <= 299) return "å—é™è™Ÿç¢¼ (å€åŸŸå…§ä½¿ç”¨)";
      if (prefix === 950) return "GS1 å…¨çƒç¸½éƒ¨";
      if (prefix === 977) return "é€£çºŒå‡ºç‰ˆç‰© (æœŸåˆŠ/é›œèªŒ)";
      if (prefix === 978 || prefix === 979) return "æ›¸ç±èˆ‡æ¨‚è­œ (Bookland)";
      if (prefix === 980) return "é€€æ¬¾æ”¶æ“šå°ˆç”¨";
      if (prefix >= 981 && prefix <= 983) return "å…±åŒè²¨å¹£å€å„ªæƒ åˆ¸";
      if (prefix >= 990 && prefix <= 999) return "å„ªæƒ åˆ¸/æŠ˜åƒ¹åˆ¸æ¢ç¢¼";

      return translations[currentLang].unknownCode;
    }

    // â”€â”€ ç›¸æ©Ÿè³‡æºå–å¾—èˆ‡å•Ÿå‹• â”€â”€
    async function getCameraList() {
      if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) return [];
      try {
        const devices = await navigator.mediaDevices.enumerateDevices();
        return devices.filter(d => d.kind === 'videoinput');
      } catch(e) { return []; }
    }

    async function startScan() {
      document.getElementById('scanner-container').style.display = 'flex';
      const t = translations[currentLang];
      const select = document.getElementById('cameraSelect');
      select.innerHTML = `<option>${t.camLoading}</option>`;
      select.disabled = true;

      const cameras = await getCameraList();
      if (cameras.length > 0) {
        select.innerHTML = '';
        cameras.forEach((cam, idx) => {
          const opt = document.createElement('option');
          opt.value = cam.deviceId;
          opt.text = cam.label || `${t.camDefault} ${idx + 1}`;
          select.appendChild(opt);
        });
        select.disabled = false;
        const backCam = cameras.find(c => /back|rear|environment|å¾Œ/i.test(c.label));
        const defaultCamId = backCam ? backCam.deviceId : cameras[cameras.length - 1].deviceId;
        select.value = defaultCamId;
        await startEngine(defaultCamId);
      } else {
        select.innerHTML = `<option value="">${t.camDefault}</option>`;
        await startEngineFallback();
      }
    }

    async function startEngine(deviceId) {
      if (isQuaggaScanning) Quagga.stop();
      currentCameraId = deviceId;
      quaggaLastCode = ""; quaggaCodeCount = 0;
      document.getElementById('quagga-reader').innerHTML = ''; 

      return new Promise((resolve, reject) => {
        Quagga.init({
          inputStream: {
            name: "Live", type: "LiveStream", target: document.querySelector('#quagga-reader'),
            constraints: { deviceId: { exact: deviceId }, width: { ideal: 1280 }, height: { ideal: 720 } }
          },
          decoder: { readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"] }, // å°ˆæ³¨æ–¼å•†å“æ¢ç¢¼
          locate: true
        }, function(err) {
          if (err) { alert(translations[currentLang].alertCamFail); reject(err); stopScan(); return; }
          Quagga.start();
          isQuaggaScanning = true;
          setTimeout(() => checkTorchCapability(Quagga.CameraAccess.getActiveTrack()), 800);
          resolve();
        });
      });
    }

    async function startEngineFallback() {
      if (isQuaggaScanning) Quagga.stop();
      currentCameraId = null;
      quaggaLastCode = ""; quaggaCodeCount = 0;
      document.getElementById('quagga-reader').innerHTML = '';
      return new Promise((resolve, reject) => {
        Quagga.init({
          inputStream: {
            name: "Live", type: "LiveStream", target: document.querySelector('#quagga-reader'),
            constraints: { facingMode: "environment", width: { ideal: 1280 }, height: { ideal: 720 } }
          },
          decoder: { readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader"] },
          locate: true
        }, function(err) {
          if (err) { alert(translations[currentLang].alertCamFail); reject(err); stopScan(); return; }
          Quagga.start();
          isQuaggaScanning = true;
          setTimeout(() => checkTorchCapability(Quagga.CameraAccess.getActiveTrack()), 800);
          resolve();
        });
      });
    }

    async function switchCamera(deviceId) {
      if (!deviceId) return;
      document.getElementById('cameraSelect').disabled = true;
      document.getElementById('btn-torch').style.display = 'none';
      try { await startEngine(deviceId); } catch (e) {} 
      finally { document.getElementById('cameraSelect').disabled = false; }
    }

    function stopScan() {
      document.getElementById('scanner-container').style.display = 'none';
      isTorchOn = false; document.getElementById('btn-torch').classList.remove('active');
      if (isQuaggaScanning) { Quagga.stop(); isQuaggaScanning = false; }
    }

    // â”€â”€ Quagga è§£ç¢¼èˆ‡ç¹ªåœ–äº‹ä»¶ â”€â”€
    Quagga.onDetected((result) => {
      if (!isQuaggaScanning) return;
      const code = result.codeResult.code;
      if (code === quaggaLastCode) {
        quaggaCodeCount++;
        if (quaggaCodeCount >= REQUIRED_MATCHES) processBarcodeResult(code);
      } else {
        quaggaLastCode = code; quaggaCodeCount = 1;
      }
    });

    Quagga.onProcessed(function(result) {
      if (!isQuaggaScanning) return;
      var drawingCtx = Quagga.canvas.ctx.overlay, drawingCanvas = Quagga.canvas.dom.overlay;
      if (result) {
        if (result.boxes) {
          drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
          result.boxes.filter(box => box !== result.box).forEach(box => {
              Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
          });
        }
        if (result.box) Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
        if (result.codeResult && result.codeResult.code) Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
      }
    });

    // â”€â”€ æ‰‹é›»ç­’é‚è¼¯ â”€â”€
    async function checkTorchCapability(track) {
      const btnTorch = document.getElementById('btn-torch');
      if (track && typeof track.getCapabilities === 'function') {
        const caps = track.getCapabilities();
        const isSupported = !!caps.torch || ('fillLightMode' in caps && caps.fillLightMode.includes('flash'));
        if (isSupported) {
          btnTorch.style.display = 'block';
          if (isTorchOn) {
            try { await track.applyConstraints({ advanced: [{ torch: true }] }); btnTorch.classList.add('active'); } 
            catch(e) { isTorchOn = false; btnTorch.classList.remove('active'); }
          }
          return;
        }
      }
      btnTorch.style.display = 'none'; isTorchOn = false; btnTorch.classList.remove('active');
    }

    async function toggleTorch() {
      let targetState = !isTorchOn;
      try {
        const track = Quagga.CameraAccess.getActiveTrack();
        if (track && typeof track.applyConstraints === 'function') {
           await track.applyConstraints({ advanced: [{ torch: targetState }] });
           isTorchOn = targetState;
           document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
        }
      } catch (err) {
        const btn = document.getElementById('btn-torch');
        btn.classList.add('error-shake');
        setTimeout(() => btn.classList.remove('error-shake'), 300);
        document.getElementById('btn-torch').classList.toggle('active', isTorchOn);
      }
    }

    // â”€â”€ çµæœé¡¯ç¤ºé‚è¼¯ â”€â”€
    function manualQuery() {
      const code = document.getElementById('barcodeInput').value.trim();
      if (!code || isNaN(code)) {
        alert(translations[currentLang].alertEmpty); return;
      }
      processBarcodeResult(code);
    }

    function processBarcodeResult(barcode) {
      if (navigator.vibrate) navigator.vibrate(200);
      if (isQuaggaScanning) stopScan(); 
      
      // è™•ç†é¡¯ç¤º
      let fullBarcode = barcode;
      if (fullBarcode.length === 12) fullBarcode = "0" + fullBarcode; // UPC è£œ 0 è½‰ EAN13

      const prefix = fullBarcode.substring(0, 3);
      const countryStr = getGS1Country(fullBarcode);

      document.getElementById('barcodeInput').value = fullBarcode;
      document.getElementById('modalBarcode').innerText = fullBarcode;
      document.getElementById('modalPrefix').innerText = prefix;
      document.getElementById('modalCountry').innerText = countryStr;
      
      document.getElementById('resultModal').style.display = 'flex';
    }

    function closeModal() {
      document.getElementById('resultModal').style.display = 'none';
    }

    window.onload = () => {
      changeLanguage();
    };
  </script>
</body>
</html>
